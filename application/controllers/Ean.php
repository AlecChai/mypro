<?php/** * Created by PhpStorm. * User:  我是一颗菜 * Date: 2018/6/5 * Time: 15:33 */class Ean extends MY_Controller{    public function __construct()    {        parent::__construct();    }        public  function index()    {        extract($_POST);        $where = [];        if($sku) $where['sku']=trim($sku);        if($ean_code) $where['ean_code'] =trim($ean_code);                $currentPage   = element('currentPage',$_POST,1);        $pageSize      = element('pageSize',$_POST,10);        $page          = ($currentPage-1)*$pageSize;        $rows          = $this->db->where($where)->limit($pageSize,$page)->select('*')->get('t_ean')->result_array();        //echo $this->db->last_query();        $count_res     = $this->db->where($where)->select("count(*) as num ")->get('t_ean')->row();        $num           = $count_res->num;        $data['data']  = $rows;        $data['total'] = intval($num);                echo json_encode($data);      }        //EAN删除    public function delete()    {        $id=$this->input->get('id');        $this->db->where('id',$id)->delete('t_ean');        re_json([],0,'删除成功');    }        //导入EAN    public function  ean_put(){        //文件上传        $file = $_FILES['file'];        if(!is_dir('./uploads/ean/ean_put/')){            mkdir('./uploads/ean/ean_put/');        }                $filepath="./uploads/ean/ean_put/".time().'.xls';                $res=move_uploaded_file($file['tmp_name'],$filepath);                $data= array('A'=>'ean_code','B'=>'sku','C'=>'is_use');        $tablename= 't_ean';        $this->excel_eanput($filepath,$data,$tablename);            }        private function excel_eanput($filepath,$data,$tablename){        $this->load->library("PHPExcel");    //引入PHPExcel类        $PHPExcel=new PHPExcel();        $PHPReader=new PHPExcel_reader_excel2007();        if(!$PHPReader->canRead($filepath)){            $PHPReader = new PHPExcel_Reader_Excel5();            if(!$PHPReader->canRead($filepath)){                echo 'No Excel';                return;            }        }        // 加载excel文件        $PHPExcel = $PHPReader->load($filepath);        // 读取excel文件中的第一个工作表        $currentSheet = $PHPExcel->getSheet(0);        // 取得最大的列号        $allColumn = $currentSheet->getHighestColumn();        // 取得一共有多少行        $allRow = $currentSheet->getHighestRow();                // 从第二行开始输出，因为excel表中第一行为列名        $len = 0;        $num = 0;        $error =0;        $res =array();        for($currentRow =2;$currentRow <= $allRow;$currentRow++){            for($currentColumn ='A';$currentColumn <= $allColumn;$currentColumn++){                $val = $currentSheet->getCellByColumnAndRow(ord($currentColumn)-65,$currentRow)->getValue();                if($currentColumn <= $allColumn){                    $data1[$currentColumn] = $val;                                    }            }            foreach($data as $key=>$val){                $data2[$val]     = $data1[$key];            }            $ean_data['ean_code']   = trim($data2['ean_code']);            $ean_data['sku']   = trim($data2['sku']);            $ean_data['is_use']  = trim($data2['is_use']) == '是'? 1 :2;            $ean_data['create_time'] =date('Y-m-d H:i:s');            $ean_data['created_man'] =$_SESSION['realname'];            if($ean_data['ean_code'] && $ean_data['sku'] && $ean_data['is_use'] ){                $result=$this->db->insert($tablename,$ean_data);                $num++;            }            $len++;        }        if($num=0){            $res['s']    = 0;            $res['msg']  ="导入失败";        }else{            $res['s']    = 1;            $res['msg']  = "导入成功";                    }        var_dump($res);        echo json_encode($res);    }}