<?php/** * Created by PhpStorm. * User:  我是一颗菜 * Date: 2018/6/4 * Time: 16:51 */class Category extends MY_Controller{    public function __construct()    {        parent::__construct();    }        public function index()    {        extract($_POST);        $wh=[];        if($name_cn) $wh['name_cn'] = $name_cn;                $currentPage = element('currentPage',$_POST,1);        $pagesize =element('pageSize',$_POST,10);        $page = ($currentPage -1)*$pagesize;                $rows=$this->db->like($wh)->limit($pagesize,$page)->select("*")->get('t_category')->result_array();        $count_res=$this->db->like($wh)->select("count(*) as num")->get('t_category')->row_array();        $count=$count_res['num'];        $data['data'] =$rows;        $data['total'] = intval($count);                echo json_encode($data);    }        //类别增加    public function add()    {        if(!$_POST) return;        extract($_POST);        $data = array(            'cat_1'  => $cat_1,            'cat_2'  => $cat_2,            'cat_3'  => $cat_3,            'cat_4'  => $cat_4,            'name_cn'=> $name_cn,            'is_ean' => $is_ean,            'code'   => $code,            'create_time'=>date('Y-m-d H:i:s'),            'created_man' =>$_SESSION['realname'],                    );        $this->db->insert("t_category",$data);        re_json([],0,'添加成功');                    }       //类别修改    public function edit()    {        if(!$_POST) return;        extract($_POST);        $id= intval($id);        $data =array(            'cat_1' =>$cat_1,            'cat_2' =>$cat_2,            'cat_3' =>$cat_3,            'cat_4' =>$cat_4,            'name_cn'=>$name_cn,            'code'  =>$code,            'is_ean'=>$is_ean,        );        $res =$this->db->where('id',$id)->update('t_category',$data);        re_json([], 0, '更新成功');    }    //类别删除    public function delete()    {        $id=intval($this->input->get("id"));        $this->db->where('id',$id)->delete("t_category");        re_json([],0,'删除成功');    }        //类别批量导入    public function  category_put(){        //文件上传        $file = $_FILES['file'];        if(!is_dir('./uploads/category/category_put')){            mkdir('./uploads/category/category_put');        }                $filepath="./uploads/category/category_put/".time().'.xls';                $res=move_uploaded_file($file['tmp_name'],$filepath);                $data= array('A'=>'cat_1','B'=>'cat_2','C'=>'cat_3','D'=>'cat_4','E'=>'name_cn','F'=>'is_ean','G'=>'code');        $tablename= 't_category';        $this->excel_categoryput($filepath,$data,$tablename);            }        private function excel_categoryput($filepath,$data,$tablename){        $this->load->library("PHPExcel");    //引入PHPExcel类        $PHPExcel=new PHPExcel();        $PHPReader=new PHPExcel_reader_excel2007();        if(!$PHPReader->canRead($filepath)){            $PHPReader = new PHPExcel_Reader_Excel5();            if(!$PHPReader->canRead($filepath)){                echo 'No Excel';                return;            }        }        // 加载excel文件        $PHPExcel = $PHPReader->load($filepath);        // 读取excel文件中的第一个工作表        $currentSheet = $PHPExcel->getSheet(0);        // 取得最大的列号        $allColumn = $currentSheet->getHighestColumn();        // 取得一共有多少行        $allRow = $currentSheet->getHighestRow();                // 从第二行开始输出，因为excel表中第一行为列名        $len = 0;        $num = 0;        $error =0;        $res =array();        for($currentRow =2;$currentRow <= $allRow;$currentRow++){            for($currentColumn ='A';$currentColumn <= $allColumn;$currentColumn++){                $val = $currentSheet->getCellByColumnAndRow(ord($currentColumn)-65,$currentRow)->getValue();                if($currentColumn <= $allColumn){                    $data1[$currentColumn] = $val;                                    }            }            foreach($data as $key=>$val){                $data2[$val]     = $data1[$key];            }                        $cate_data['cat_1']   = trim($data2['cat_1']);            $cate_data['cat_2']   = trim($data2['cat_2']);            $cate_data['cat_3']   = trim($data2['cat_3']);            $cate_data['cat_4']   = trim($data2['cat_4']);            $cate_data['name_cn'] = trim($data2['name_cn']);            $cate_data['is_ean']  = trim($data2['is_ean']) == '是'? 1 :2;            $cate_data['code']    = trim($data2['code']) ;            $cate_data['create_time'] =date('Y-m-d H:i:s');            $cate_data['created_man'] =$_SESSION['realname'];            if($cate_data['cat_1'] && $cate_data['cat_2'] && $cate_data['name_cn'] && $cate_data['is_ean'] && $cate_data['code']){                $result=$this->db->insert($tablename,$cate_data);                $num++;            }            $len++;        }        if($num=0){            $res['s']    = 0;            $res['msg']  ="导入失败";        }else{            $res['s']    = 1;            $res['msg']  = "导入成功";                    }        echo json_encode($res);    }    }